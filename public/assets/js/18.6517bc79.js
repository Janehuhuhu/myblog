(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{415:function(t,s,a){t.exports=a.p+"assets/img/bucket.b4d95eab.png"},452:function(t,s,a){"use strict";a.r(s);var n=a(45),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h3",{attrs:{id:"下载限速"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#下载限速"}},[t._v("#")]),t._v(" 下载限速")]),t._v(" "),n("hr"),t._v(" "),n("h3",{attrs:{id:"限速介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限速介绍"}},[t._v("#")]),t._v(" 限速介绍")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("简介")])])]),t._v(" "),n("p",[t._v("在生产环境中，为了保护WEB服务器的安全，我们都会对用户的访问做出一些限制，保证服务器的安全及资源的合理分配。")]),t._v(" "),n("p",[t._v("限流（rate limiting）是NGINX众多特性中最有用的，也是经常容易被误解和错误配置的，特性之一访问请求限速。该特性可以限制某个用户在一个给定时间段内能够产生的HTTP请求数。请求可以简单到就是一个对于主页的GET请求或者一个登陆表格的POST请求。用于安全目的上，比如减慢暴力密码破解攻击。通过限制进来的请求速率，并且（结合日志）标记出目标URLs来帮助防范DDoS攻击。一般地说，限流是用在保护上游应用服务器不被在同一时刻的大量用户请求湮没\n")]),n("div",{staticStyle:{"margin-top":"30px"}}),n("p"),t._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[t._v("限速方法")])])]),t._v(" "),n("ul",[n("li",[t._v("下载速度限速")]),t._v(" "),n("li",[t._v("单位时间内请求数限制")]),t._v(" "),n("li",[t._v("基于客户端的并发连接限速\n"),n("div",{staticStyle:{"margin-top":"30px"}})])]),t._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[n("strong",[t._v("nginx限速模块")])])]),t._v(" "),n("p",[t._v("Nginx官方版本限制IP的连接和并发分别有两个模块：")]),t._v(" "),n("ul",[n("li",[t._v("limit_req_zone 用来限制单位时间内的请求数，即速率限制,采用的漏桶算法 “leaky bucket”。")]),t._v(" "),n("li",[t._v("limit_req_conn 用来限制同一时间连接数，即并发限制。\n"),n("div",{staticStyle:{"margin-top":"50px"}})])]),t._v(" "),n("h3",{attrs:{id:"应用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[t._v("#")]),t._v(" 应用场景")]),t._v(" "),n("ul",[n("li",[t._v("下载限速：限制现在速度及并发连接数，应用在下载服务器中，保护带宽及服务器的IO资源。")]),t._v(" "),n("li",[t._v("请求限速：限制单位时间内用户访问请求，防止恶意攻击，保护服务器及资源安全。\n"),n("div",{staticStyle:{"margin-top":"50px"}})])]),t._v(" "),n("h3",{attrs:{id:"限速原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限速原理"}},[t._v("#")]),t._v(" 限速原理")]),t._v(" "),n("p",[t._v("水（请求）从上方倒入水桶，从水桶下方流出（被处理），来不及流出的水存在水桶中（缓冲），以固定速率流出；\n水桶满后水溢出（丢弃）。这个算法的核心是：缓存请求、匀速处理、多余的请求直接丢弃。\n"),n("img",{staticStyle:{"margin-top":"20px"},attrs:{src:a(415),width:"400px"}})]),n("div",{staticStyle:{"margin-top":"50px"}}),n("p"),t._v(" "),n("h3",{attrs:{id:"接入方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#接入方式"}},[t._v("#")]),t._v(" 接入方式")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("单位时间内请求数限制")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("#基于"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("对下载速率做限制  限制每秒处理"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("次请求，缓存区为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" \nhttp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  limit_req_zone $binary_remote_addr zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m rate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      limit_req zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism burst"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" nodelay"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nlimit_req_zone $binary_remote_addr zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m rate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n第一个参数：$binary_remote_addr 表示通过remote_addr这个标识来做限制，“binary_”的目的是缩写内存占用量，是限制同一客户端ip地址。\n第二个参数：zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m表示生成一个大小为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("M，名字为baism的内存区域，用来存储访问的频次信息。\n第三个参数：rate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("s表示允许相同标识的客户端的访问频次，这里限制的是每秒"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("次，还可以有比如"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("m的。\n\nlimit_req zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism burst"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" nodelay"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n第一个参数：zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("baism 设置使用哪个配置区域来做限制，与上面limit_req_zone 里的name对应。\n第二个参数：burst"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("，重点说明一下这个配置，burst爆发的意思，这个配置的意思是设置一个大小为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("的缓冲区。当有大量请求（爆发）过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。\n第三个参数：nodelay，如果设置，超过访问频次而且缓冲区也满了的时候就会直接返回"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("503")]),t._v("，如果没有设置，则所有请求会等待排队。\n")])])]),n("div",{staticStyle:{"margin-top":"30px"}}),t._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[t._v("限制并发连接数")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("#基于"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("做连接限制  限制同一"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("并发为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nlimit_conn_zone $binary_remote_addr zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("addr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen       "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name  localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root   html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index  index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("htm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    limit_conn addr "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticStyle:{"margin-top":"30px"}}),t._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[n("strong",[t._v("限制下载速度")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("下载速度为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("k\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen       "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name  localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root   html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index  index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("htm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    limit_rate "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticStyle:{"margin-top":"30px"}}),t._v(" "),n("ol",{attrs:{start:"4"}},[n("li",[n("strong",[t._v("综合案例")]),n("br"),t._v("\n限制web服务器请求处理为1秒一个，触发值为5；限制并发连接数为4;限制下载速度为100.")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("http "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  include       mime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  default_type  application"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("octet"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("stream"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  sendfile        on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  keepalive_timeout  "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n#基于"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("做连接限制  限制同一"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("并发为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  下载速度为"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("K\nlimit_conn_zone $binary_remote_addr zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("addr"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n#基于"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IP")]),t._v("对下载速率做限制  限制每秒处理"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("次请求，对突发超过"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("个以后的请求返回"),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("503")]),t._v("\nlimit_req_zone $binary_remote_addr zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("one"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("m rate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen       "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name  localhost"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root   html"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index  index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("htm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  location "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("abc "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    limit_req zone"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("one burst"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" nodelay"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    limit_conn addr "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    limit_rate "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticStyle:{"margin-top":"50px"}}),t._v(" "),n("h3",{attrs:{id:"🔗相关链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🔗相关链接"}},[t._v("#")]),t._v(" 🔗相关链接")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://www.zutuanxue.com/home/4/54_284",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载限速"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);